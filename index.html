<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Drive Toplu G√∂rsel Y√ºkleyici v2.3</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/heic2any@0.0.4/dist/heic2any.min.js" 
            crossorigin="anonymous" 
            referrerpolicy="no-referrer"></script>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        * {
            font-family: 'Plus Jakarta Sans', sans-serif;
        }
        body {
            background: linear-gradient(145deg, #0f172a 0%, #1e293b 50%, #0f172a 100%);
            min-height: 100vh;
        }
        .glass-card {
            background: rgba(255, 255, 255, 0.03);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.08);
        }
        .upload-zone {
            background: linear-gradient(135deg, rgba(59, 130, 246, 0.1) 0%, rgba(147, 51, 234, 0.1) 100%);
            border: 2px dashed rgba(99, 102, 241, 0.5);
            transition: all 0.3s ease;
        }
        .upload-zone:hover, .upload-zone.dragover {
            border-color: #818cf8;
            background: linear-gradient(135deg, rgba(59, 130, 246, 0.2) 0%, rgba(147, 51, 234, 0.2) 100%);
            transform: scale(1.01);
        }
        .file-item {
            background: rgba(255, 255, 255, 0.02);
            border: 1px solid rgba(255, 255, 255, 0.06);
            transition: all 0.3s ease;
        }
        .file-item:hover {
            background: rgba(255, 255, 255, 0.05);
        }
        .file-item.success {
            background: rgba(34, 197, 94, 0.1);
            border-color: rgba(34, 197, 94, 0.3);
        }
        .file-item.error {
            background: rgba(239, 68, 68, 0.1);
            border-color: rgba(239, 68, 68, 0.3);
        }
        .file-item.processing {
            background: rgba(59, 130, 246, 0.1);
            border-color: rgba(59, 130, 246, 0.3);
        }
        .btn-primary {
            background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
            transition: all 0.3s ease;
        }
        .btn-primary:hover:not(:disabled) {
            background: linear-gradient(135deg, #818cf8 0%, #a78bfa 100%);
            transform: translateY(-2px);
            box-shadow: 0 10px 40px -10px rgba(99, 102, 241, 0.5);
        }
        .btn-primary:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        .status-badge {
            font-size: 10px;
            padding: 2px 8px;
            border-radius: 20px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        .spinner {
            width: 14px;
            height: 14px;
            border: 2px solid rgba(255,255,255,0.3);
            border-top-color: #fff;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .file-item {
            animation: fadeIn 0.3s ease-out;
        }
        .thumbnail {
            width: 56px;
            height: 56px;
            object-fit: cover;
            border-radius: 8px;
            background: rgba(255,255,255,0.05);
        }
        ::-webkit-scrollbar {
            width: 6px;
        }
        ::-webkit-scrollbar-track {
            background: rgba(255,255,255,0.05);
            border-radius: 3px;
        }
        ::-webkit-scrollbar-thumb {
            background: rgba(255,255,255,0.2);
            border-radius: 3px;
        }
        .input-field {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            transition: all 0.3s ease;
        }
        .input-field:focus {
            outline: none;
            border-color: rgba(99, 102, 241, 0.5);
            background: rgba(255, 255, 255, 0.08);
        }
        .slider-track {
            -webkit-appearance: none;
            appearance: none;
            height: 6px;
            border-radius: 3px;
            background: rgba(255,255,255,0.1);
        }
        .slider-track::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: linear-gradient(135deg, #6366f1, #8b5cf6);
            cursor: pointer;
            box-shadow: 0 2px 10px rgba(99, 102, 241, 0.4);
        }
        .log-area {
            background: rgba(0, 0, 0, 0.3);
            font-family: 'Monaco', 'Menlo', monospace;
            font-size: 11px;
            line-height: 1.6;
        }
    </style>
</head>
<body class="p-4 md:p-8">
    <div class="max-w-3xl mx-auto">
        <!-- Header -->
        <div class="text-center mb-8">
            <div class="flex justify-center items-center gap-2 mb-2">
                <h1 class="text-3xl md:text-4xl font-bold text-white">
                    üìÅ Drive Toplu Y√ºkleyici
                </h1>
                <span class="bg-indigo-500/30 text-indigo-300 text-xs font-medium px-2 py-1 rounded-full">v2.3</span>
            </div>
            <p class="text-gray-400 text-sm">
                JPG, PNG ve HEIC dosyalarƒ±nƒ± optimize edip Google Drive'a y√ºkleyin
            </p>
        </div>

        <!-- Main Card -->
        <div class="glass-card rounded-2xl p-6 md:p-8">
            <!-- Webhook URL -->
            <div class="mb-6">
                <label class="block text-gray-300 text-sm font-medium mb-2">
                    API Baƒülantƒ± Adresi (n8n Webhook)
                </label>
                <input type="url" id="webhookUrl" 
                       placeholder="https://api.example.com/upload"
                       class="input-field w-full px-4 py-3 rounded-xl text-white placeholder-gray-500">
                <p class="text-gray-500 text-xs mt-1">Y√ºkleyici servis adresinizi buraya yapƒ±≈ütƒ±rƒ±n</p>
            </div>

            <!-- Folder Name -->
            <div class="mb-6">
                <label class="block text-gray-300 text-sm font-medium mb-2">
                    Hedef Klas√∂r
                </label>
                <input type="text" id="folderName" value="FIS_DEPO"
                       class="input-field w-full px-4 py-3 rounded-xl text-white placeholder-gray-500">
            </div>

            <!-- Upload Zone -->
            <div id="uploadZone" class="upload-zone rounded-2xl p-8 md:p-12 text-center cursor-pointer mb-6">
                <div class="text-5xl mb-4">üì∏</div>
                <div class="text-white font-semibold text-lg mb-1">
                    G√∂rselleri S√ºr√ºkle & Bƒ±rak
                </div>
                <div class="text-gray-400 text-sm">
                    veya tƒ±klayarak se√ßin ‚Ä¢ JPG, PNG, HEIC
                </div>
                <input type="file" id="fileInput" accept="image/*,.heic,.HEIC" multiple class="hidden">
            </div>

            <!-- Settings Toggle -->
            <div class="mb-6">
                <button id="settingsToggle" class="flex items-center gap-2 text-gray-400 hover:text-white transition text-sm">
                    <span>‚öôÔ∏è</span>
                    <span>Optimizasyon Ayarlarƒ±</span>
                    <span id="toggleArrow" class="transition-transform">‚ñº</span>
                </button>
                
                <div id="settingsPanel" class="hidden mt-4 p-4 rounded-xl bg-black/20 space-y-4">
                    <div>
                        <div class="flex justify-between text-sm mb-2">
                            <span class="text-gray-400">Maksimum Geni≈ülik</span>
                            <span id="maxWidthValue" class="text-indigo-400 font-medium">2048px</span>
                        </div>
                        <input type="range" id="maxWidth" min="800" max="3000" value="2048" step="100" 
                               class="slider-track w-full">
                    </div>
                    <div>
                        <div class="flex justify-between text-sm mb-2">
                            <span class="text-gray-400">JPEG Kalitesi</span>
                            <span id="qualityValue" class="text-indigo-400 font-medium">85%</span>
                        </div>
                        <input type="range" id="quality" min="50" max="100" value="85" step="5" 
                               class="slider-track w-full">
                    </div>
                </div>
            </div>

            <!-- File List -->
            <div id="fileListContainer" class="hidden mb-6">
                <div class="flex justify-between items-center mb-3">
                    <h3 class="text-white font-semibold">
                        Dosya Listesi (<span id="fileCount">0</span>)
                    </h3>
                    <div class="flex gap-2">
                        <button id="clearSuccessBtn" class="hidden text-green-400 hover:text-green-300 text-sm transition px-2 py-1 rounded hover:bg-green-500/10">
                            ‚úì Ba≈üarƒ±lƒ±larƒ± Kaldƒ±r
                        </button>
                        <button id="clearAllBtn" class="text-red-400 hover:text-red-300 text-sm transition px-2 py-1 rounded hover:bg-red-500/10">
                            T√ºm√ºn√º Temizle
                        </button>
                    </div>
                </div>
                <div id="fileList" class="space-y-2 max-h-80 overflow-y-auto pr-2">
                    <!-- Dosyalar buraya eklenecek -->
                </div>
            </div>

            <!-- Progress Bar (Y√ºkleme sƒ±rasƒ±nda g√∂r√ºn√ºr) -->
            <div id="progressContainer" class="hidden mb-6">
                <div class="flex justify-between items-center mb-2">
                    <span class="text-white font-medium">Y√ºkleme Durumu</span>
                    <span id="progressText" class="text-indigo-400 font-semibold">0 / 0</span>
                </div>
                <div class="w-full bg-gray-700 rounded-full h-3 overflow-hidden">
                    <div id="progressBar" class="bg-gradient-to-r from-indigo-500 to-purple-500 h-3 rounded-full transition-all duration-300" style="width: 0%"></div>
                </div>
                <div class="flex justify-between text-xs text-gray-500 mt-1">
                    <span id="progressSuccess" class="text-green-400">‚úì 0 ba≈üarƒ±lƒ±</span>
                    <span id="progressError" class="text-red-400">‚úó 0 hatalƒ±</span>
                    <span id="progressRemaining" class="text-yellow-400">‚è≥ 0 kalan</span>
                </div>
            </div>

            <!-- Upload Button -->
            <button id="uploadBtn" disabled
                    class="btn-primary w-full py-4 rounded-xl text-white font-semibold text-lg">
                <span id="uploadBtnText">Dosya Se√ßin</span>
            </button>

            <!-- Log Area -->
            <div id="logContainer" class="hidden mt-6">
                <div class="flex justify-between items-center mb-2">
                    <span class="text-gray-400 text-sm">ƒ∞≈ülem Loglarƒ±</span>
                    <button id="clearLogBtn" class="text-gray-500 hover:text-gray-300 text-xs">Temizle</button>
                </div>
                <div id="logArea" class="log-area rounded-xl p-4 h-32 overflow-y-auto text-gray-400">
                </div>
            </div>
        </div>

        <!-- Footer -->
        <div class="text-center mt-6 text-gray-500 text-xs">
            ¬© 2025 Dijimasyon. T√ºm haklarƒ± saklƒ±dƒ±r.
        </div>
    </div>

    <script>
        // ============================================
        // DOM Elements
        // ============================================
        const uploadZone = document.getElementById('uploadZone');
        const fileInput = document.getElementById('fileInput');
        const fileList = document.getElementById('fileList');
        const fileListContainer = document.getElementById('fileListContainer');
        const fileCountSpan = document.getElementById('fileCount');
        const uploadBtn = document.getElementById('uploadBtn');
        const uploadBtnText = document.getElementById('uploadBtnText');
        const webhookInput = document.getElementById('webhookUrl');
        const folderInput = document.getElementById('folderName');
        const settingsToggle = document.getElementById('settingsToggle');
        const settingsPanel = document.getElementById('settingsPanel');
        const toggleArrow = document.getElementById('toggleArrow');
        const maxWidthSlider = document.getElementById('maxWidth');
        const maxWidthValue = document.getElementById('maxWidthValue');
        const qualitySlider = document.getElementById('quality');
        const qualityValue = document.getElementById('qualityValue');
        const clearAllBtn = document.getElementById('clearAllBtn');
        const logContainer = document.getElementById('logContainer');
        const logArea = document.getElementById('logArea');
        const clearLogBtn = document.getElementById('clearLogBtn');
        
        // Progress elements
        const progressContainer = document.getElementById('progressContainer');
        const progressBar = document.getElementById('progressBar');
        const progressText = document.getElementById('progressText');
        const progressSuccess = document.getElementById('progressSuccess');
        const progressError = document.getElementById('progressError');
        const progressRemaining = document.getElementById('progressRemaining');
        const clearSuccessBtn = document.getElementById('clearSuccessBtn');

        // ============================================
        // State
        // ============================================
        let selectedFiles = [];
        let isUploading = false;

        // ============================================
        // Utility Functions
        // ============================================
        function formatBytes(bytes) {
            if (bytes === 0) return '0 B';
            const k = 1024;
            const sizes = ['B', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return (bytes / Math.pow(k, i)).toFixed(1) + ' ' + sizes[i];
        }

        function log(message, type = 'info') {
            logContainer.classList.remove('hidden');
            const time = new Date().toLocaleTimeString('tr-TR');
            const colors = {
                info: 'text-gray-400',
                success: 'text-green-400',
                error: 'text-red-400',
                warning: 'text-yellow-400'
            };
            logArea.innerHTML += `<div class="${colors[type]}">[${time}] ${message}</div>`;
            logArea.scrollTop = logArea.scrollHeight;
        }

        function generateId() {
            return Math.random().toString(36).substr(2, 9);
        }

        /**
         * Dosya nesnesindeki status'u g√ºnceller.
         * @param {string} id 
         * @param {string} newStatus 'waiting', 'processing', 'uploading', 'success', 'error'
         */
        function updateFileState(id, newStatus, message = '') {
            const fileObj = selectedFiles.find(f => f.id === id);
            if (fileObj) {
                fileObj.status = newStatus;
                updateFileStatusUI(id, newStatus, message);
            }
        }

        // ============================================
        // Progress & Auto-Scroll Functions
        // ============================================
        function updateProgress(current, total, success, errors, remaining) {
            const percent = total > 0 ? Math.round((current / total) * 100) : 0;
            
            progressBar.style.width = percent + '%';
            progressText.textContent = `${current} / ${total}`;
            progressSuccess.textContent = `‚úì ${success} ba≈üarƒ±lƒ±`;
            progressError.textContent = `‚úó ${errors} hatalƒ±`;
            progressRemaining.textContent = `‚è≥ ${remaining} kalan`;
        }

        function scrollToFile(fileId) {
            const fileElement = document.getElementById(`file-${fileId}`);
            if (fileElement) {
                fileElement.scrollIntoView({ 
                    behavior: 'smooth', 
                    block: 'center'
                });
            }
        }

        // ============================================
        // HEIC Detection & Conversion
        // ============================================
        function isHeicFile(file) {
            const name = file.name.toLowerCase();
            const type = file.type.toLowerCase();
            return name.endsWith('.heic') || name.endsWith('.heif') || 
                   type === 'image/heic' || type === 'image/heif';
        }

        async function convertHeicToJpeg(file) {
            log(`HEIC d√∂n√º≈üt√ºr√ºl√ºyor: ${file.name}`, 'info');
            
            // K√ºt√ºphane kontrol√º
            if (typeof heic2any === 'undefined') {
                throw new Error('HEIC k√ºt√ºphanesi y√ºklenemedi. Sayfayƒ± yenileyin.');
            }
            
            try {
                const blob = await heic2any({
                    blob: file,
                    toType: 'image/jpeg',
                    quality: 0.92
                });
                
                // heic2any bazen array d√∂nd√ºr√ºr
                const resultBlob = Array.isArray(blob) ? blob[0] : blob;
                
                log(`HEIC d√∂n√º≈üt√ºr√ºld√º: ${file.name}`, 'success');
                return resultBlob;
            } catch (error) {
                log(`HEIC d√∂n√º≈ü√ºm hatasƒ±: ${error.message}`, 'error');
                throw error;
            }
        }

        // ============================================
        // Image Optimization
        // ============================================
        async function optimizeImage(file) {
            const maxWidth = parseInt(maxWidthSlider.value);
            const quality = parseInt(qualitySlider.value) / 100;
            
            return new Promise((resolve, reject) => {
                const img = new Image();
                
                img.onload = () => {
                    try {
                        const canvas = document.createElement('canvas');
                        const ctx = canvas.getContext('2d');
                        
                        let width = img.width;
                        let height = img.height;
                        
                        // Boyut k√º√ß√ºltme
                        if (width > maxWidth) {
                            height = Math.round((height / width) * maxWidth);
                            width = maxWidth;
                        }
                        
                        canvas.width = width;
                        canvas.height = height;
                        
                        ctx.imageSmoothingEnabled = true;
                        ctx.imageSmoothingQuality = 'high';
                        ctx.drawImage(img, 0, 0, width, height);
                        
                        // toDataURL()'den √∂nce canvas'a √ßizim yapƒ±lmalƒ±
                        // HEIC dosyalarƒ± burada JPG olarak d√∂n√º≈üt√ºr√ºlm√º≈ü oluyor
                        const dataUrl = canvas.toDataURL('image/jpeg', quality); 
                        const base64 = dataUrl.split(',')[1];
                        // Base64 boyutu yakla≈üƒ±k olarak hesaplanƒ±yor (byte'a d√∂n√º≈ü√ºm)
                        const optimizedSize = Math.round(base64.length * 0.75); 
                        
                        resolve({
                            base64: base64,
                            width: width,
                            height: height,
                            optimizedSize: optimizedSize
                        });
                    } catch (err) {
                        reject(err);
                    }
                };
                
                img.onerror = () => reject(new Error('G√∂rsel y√ºklenemedi veya desteklenmiyor.'));
                
                // Blob'dan URL olu≈ütur
                const url = URL.createObjectURL(file);
                img.src = url;
            });
        }

        // ============================================
        // File Processing Pipeline
        // ============================================
        async function processFile(file) {
            let processedFile = file;
            
            // HEIC ise √∂nce d√∂n√º≈üt√ºr
            if (isHeicFile(file)) {
                processedFile = await convertHeicToJpeg(file);
            }
            
            // Optimize et
            const optimized = await optimizeImage(processedFile);
            
            return {
                ...optimized,
                originalSize: file.size,
                originalName: file.name
            };
        }

        // ============================================
        // UI Functions
        // ============================================
        function updateUI() {
            const count = selectedFiles.length;
            fileCountSpan.textContent = count;
            fileListContainer.classList.toggle('hidden', count === 0);
            
            // Durumlarƒ± say
            const successCount = selectedFiles.filter(f => f.status === 'success').length;
            const errorCount = selectedFiles.filter(f => f.status === 'error').length;
            const totalToProcess = selectedFiles.length - successCount;
            
            // Buton metnini ve durumunu g√ºncelle
            if (count === 0) {
                uploadBtn.disabled = true;
                uploadBtnText.textContent = 'Dosya Se√ßin';
            } else if (totalToProcess === 0 && successCount > 0) {
                 uploadBtn.disabled = true;
                 uploadBtnText.innerHTML = '‚úÖ T√ºm Dosyalar Y√ºklendi!';
            } else if (totalToProcess > 0) {
                uploadBtn.disabled = false;
                uploadBtnText.textContent = `‚¨ÜÔ∏è ${totalToProcess} Dosyayƒ± Y√ºkle / Tekrar Dene`;
            } else {
                 uploadBtn.disabled = false;
                 uploadBtnText.textContent = `‚¨ÜÔ∏è ${count} Dosyayƒ± Y√ºkle`;
            }

             // Ba≈üarƒ±lƒ± dosya varsa "Ba≈üarƒ±lƒ±larƒ± Kaldƒ±r" butonunu g√∂ster
            clearSuccessBtn.classList.toggle('hidden', successCount === 0);
        }

        function createFileCard(fileObj, index) {
            const div = document.createElement('div');
            div.id = `file-${fileObj.id}`;
            div.className = 'file-item rounded-xl p-3 flex items-center gap-3';
            
            const isHeic = isHeicFile(fileObj.file);
            const typeLabel = isHeic ? 'HEIC' : fileObj.file.type.split('/')[1]?.toUpperCase() || 'IMG';
            
            div.innerHTML = `
                <div class="thumbnail flex items-center justify-center text-2xl bg-gradient-to-br from-indigo-500/20 to-purple-500/20">
                    ${isHeic ? 'üçé' : 'üñºÔ∏è'}
                </div>
                <div class="flex-grow min-w-0">
                    <div class="text-white text-sm font-medium truncate">${fileObj.file.name}</div>
                    <div class="flex items-center gap-2 mt-1">
                        <span class="text-gray-500 text-xs">${formatBytes(fileObj.file.size)}</span>
                        <span class="text-gray-600">‚Ä¢</span>
                        <span class="text-indigo-400 text-xs font-medium">${typeLabel}</span>
                        <span id="status-${fileObj.id}" class="status-badge bg-yellow-500/20 text-yellow-400">Bekliyor</span>
                    </div>
                    <div id="info-${fileObj.id}" class="text-xs text-gray-500 mt-1"></div>
                </div>
                <button data-id="${fileObj.id}" class="remove-btn text-gray-500 hover:text-red-400 transition p-2">
                    ‚úï
                </button>
            `;
            
            // Thumbnail olu≈ütur (HEIC i√ßin placeholder)
            if (!isHeic) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    const thumb = div.querySelector('.thumbnail');
                    // Mevcut i√ßeriƒüi temizlemeden √∂nce kontrol
                    if (thumb && thumb.children.length === 0) {
                        thumb.innerHTML = `<img src="${e.target.result}" class="thumbnail">`;
                    }
                };
                reader.readAsDataURL(fileObj.file);
            }
            
            // Remove button
            div.querySelector('.remove-btn').addEventListener('click', () => {
                selectedFiles = selectedFiles.filter(f => f.id !== fileObj.id);
                div.remove();
                updateUI();
                // Y√ºkleme sƒ±rasƒ±nda silinirse progress'i de g√ºncellemek gerekebilir, 
                // ancak ≈üimdilik sadece UI/state g√ºncelleyelim.
            });
            
            return div;
        }

        function renderFileList() {
            fileList.innerHTML = '';
            selectedFiles.forEach((fileObj, index) => {
                fileList.appendChild(createFileCard(fileObj, index));
            });
            updateUI();
        }

        function updateFileStatusUI(id, status, message = '') {
            const statusEl = document.getElementById(`status-${id}`);
            const infoEl = document.getElementById(`info-${id}`);
            const cardEl = document.getElementById(`file-${id}`);
            
            if (!statusEl) return;
            
            const statusConfig = {
                waiting: { class: 'bg-yellow-500/20 text-yellow-400', text: 'Bekliyor' },
                processing: { class: 'bg-blue-500/20 text-blue-400', text: 'ƒ∞≈üleniyor...' },
                uploading: { class: 'bg-indigo-500/20 text-indigo-400', text: 'Y√ºkleniyor...' },
                success: { class: 'bg-green-500/20 text-green-400', text: 'Ba≈üarƒ±lƒ±' },
                error: { class: 'bg-red-500/20 text-red-400', text: 'Hata' }
            };
            
            const config = statusConfig[status] || statusConfig.waiting;
            
            if (status === 'processing' || status === 'uploading') {
                statusEl.innerHTML = `<span class="spinner inline-block mr-1"></span>${config.text}`;
            } else {
                statusEl.textContent = config.text;
            }
            
            statusEl.className = `status-badge ${config.class}`;
            
            if (cardEl) {
                cardEl.classList.remove('success', 'error', 'processing');
                if (status === 'success') cardEl.classList.add('success');
                if (status === 'error') cardEl.classList.add('error');
                if (status === 'processing' || status === 'uploading') cardEl.classList.add('processing');
            }
            
            if (infoEl) {
                infoEl.textContent = message;
                infoEl.className = `text-xs mt-1 ${status === 'success' ? 'text-green-400' : status === 'error' ? 'text-red-400' : 'text-gray-500'}`;
            }
        }

        // ============================================
        // Upload Logic - YENƒ∞DEN DENEME MANTIƒûI EKLENDƒ∞
        // ============================================
        async function uploadFiles() {
            const webhookUrl = webhookInput.value.trim();
            const folderName = folderInput.value.trim();
            
            if (!webhookUrl) {
                log('L√ºtfen n8n Webhook URL girin!', 'error');
                // Alternatif olarak, kullanƒ±cƒ±ya bir modal/uyarƒ± g√∂sterebilirsiniz.
                return;
            }
            
            // Sadece 'waiting' veya 'error' durumundaki dosyalarƒ± y√ºklemek i√ßin filtrele
            const filesToUpload = selectedFiles.filter(f => f.status === 'waiting' || f.status === 'error');

            if (filesToUpload.length === 0) {
                log('Y√ºklenecek bekleyen veya hatalƒ± dosya bulunamadƒ±.', 'warning');
                updateUI();
                return;
            }
            
            isUploading = true;
            uploadBtn.disabled = true;
            uploadBtnText.innerHTML = '<span class="spinner inline-block mr-2"></span>Y√ºkleniyor...';
            
            // Progress g√∂ster
            progressContainer.classList.remove('hidden');
            
            const totalFilesToProcess = filesToUpload.length;
            let currentFileIndex = 0;
            
            // T√ºm dosyalarƒ±n durumunu say
            let totalSuccess = selectedFiles.filter(f => f.status === 'success').length;
            let totalError = selectedFiles.filter(f => f.status === 'error').length;
            let totalRemaining = totalFilesToProcess;

            // ƒ∞lk progress g√ºncellemesi (t√ºm dosyalarƒ±n toplam durumu)
            updateProgress(currentFileIndex, totalFilesToProcess, totalSuccess, totalError, totalRemaining);
            
            log(`Y√ºkleme ba≈ülatƒ±ldƒ± (Toplam ƒ∞≈ülenecek: ${totalFilesToProcess})`, 'info');
            
            for (const fileObj of filesToUpload) {
                
                // Y√ºkleme ba≈ülamadan √∂nce durumu tekrar 'processing' olarak ayarla
                updateFileState(fileObj.id, 'processing', 'Yeniden Deneniyor...'); 
                scrollToFile(fileObj.id);
                
                try {
                    // ƒ∞≈üleme durumu
                    log(`ƒ∞≈üleniyor: ${fileObj.file.name}`, 'info');
                    
                    // Dosyayƒ± i≈üle (HEIC d√∂n√º≈ü√ºm + optimizasyon)
                    const processed = await processFile(fileObj.file);
                    
                    const savedBytes = processed.originalSize - processed.optimizedSize;
                    const savedPercent = Math.round((savedBytes / processed.originalSize) * 100);
                    
                    updateFileState(fileObj.id, 'uploading', `Optimize: ${formatBytes(processed.optimizedSize)} (${savedPercent}% tasarruf)`);
                    
                    // Payload hazƒ±rla
                    const payload = {
                        image_data: processed.base64,
                        filename: fileObj.file.name.replace(/\.[^/.]+$/, '') + '.jpg',
                        mimeType: 'image/jpeg',
                        folderName: folderName,
                        originalSize: formatBytes(processed.originalSize),
                        optimizedSize: formatBytes(processed.optimizedSize),
                        width: processed.width,
                        height: processed.height
                    };
                    
                    log(`G√∂nderiliyor: ${payload.filename}`, 'info');
                    
                    // Webhook'a g√∂nder
                    const response = await fetch(webhookUrl, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(payload)
                    });
                    
                    // Response'u parse et
                    let result;
                    let responseText = '';
                    
                    try {
                        responseText = await response.text();
                        result = JSON.parse(responseText);
                    } catch (e) {
                         // Eƒüer n8n'den gelen yanƒ±t JSON deƒüilse (√∂rneƒüin HTTP 500'de bo≈ü/metin olabilir)
                        result = { error: responseText || `HTTP Hata Kodu: ${response.status}` };
                    }
                    
                    log(`Response status: ${response.status}`, 'info');
                    log(`Response body (kƒ±smi): ${responseText.substring(0, 200)}`, 'info');
                    
                    // Ba≈üarƒ± kontrol√º (HTTP 200/201 VE i√ßerik ba≈üarƒ± g√∂steriyorsa)
                    if (response.ok && response.status < 400) { 
                        updateFileState(fileObj.id, 'success', `‚úÖ Y√ºklendi ‚Ä¢ ${formatBytes(processed.optimizedSize)}`);
                        log(`Ba≈üarƒ±lƒ±: ${fileObj.file.name}`, 'success');
                        totalSuccess++;
                        // Hata vermi≈ü bir dosya ba≈üarƒ±lƒ± olursa, toplam hatadan d√º≈ü
                        if (fileObj.status === 'error') totalError--; 
                    } else {
                        // n8n'den gelen 400/500 yanƒ±tlarƒ±, veya n8n i√ßindeki hata yanƒ±tƒ± buraya d√º≈üer
                        const errMsg = result.message || result.error || `n8n Hata: ${result.raw || response.statusText}`;
                        throw new Error(errMsg);
                    }
                    
                } catch (error) {
                    const errMsg = error.message.includes('HTTP') ? error.message : `API/Zaman A≈üƒ±mƒ±: ${error.message}`;
                    updateFileState(fileObj.id, 'error', `‚ùå ${errMsg.substring(0, 80)}...`);
                    log(`Hata (${fileObj.file.name}): ${error.message}`, 'error');
                    
                    // Dosya daha √∂nce 'error' durumunda deƒüilse (yani ilk kez ba≈üarƒ±sƒ±z oluyorsa), hatayƒ± artƒ±r
                    if (fileObj.status !== 'error') {
                         totalError++;
                    }
                }
                
                // ƒ∞≈ülenen dosyalar sayƒ±sƒ±nƒ± artƒ±r
                currentFileIndex++;
                totalRemaining = totalFilesToProcess - currentFileIndex;
                
                // Progress g√ºncelle
                // NOT: totalSuccess ve totalError, t√ºm listedeki g√ºncel durumlarƒ± g√∂sterir.
                updateProgress(currentFileIndex, totalFilesToProcess, totalSuccess, totalError, totalRemaining);
                
                // K√º√ß√ºk bekleme (rate limiting i√ßin)
                await new Promise(r => setTimeout(r, 300));
            }
            
            // Sonu√ß
            isUploading = false;
            
            // T√ºm dosyalarƒ±n son durumunu al
            const finalSuccessCount = selectedFiles.filter(f => f.status === 'success').length;
            const finalErrorCount = selectedFiles.filter(f => f.status === 'error').length;

            const totalMsg = `T√ºm ƒ∞≈ülemler Tamamlandƒ±: ${finalSuccessCount} ba≈üarƒ±lƒ±, ${finalErrorCount} hatalƒ±`;
            log(totalMsg, finalErrorCount > 0 ? 'warning' : 'success');
            
            // Buton durumunu g√ºncelle
            updateUI(); 
        }

        // ============================================
        // Event Listeners
        // ============================================
        
        // Upload Zone - Click
        uploadZone.addEventListener('click', () => {
            if (!isUploading) fileInput.click();
        });
        
        // File Input - Change
        fileInput.addEventListener('change', (e) => {
            if (e.target.files.length > 0) {
                handleFiles(e.target.files);
                e.target.value = '';
            }
        });
        
        // Drag & Drop
        uploadZone.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadZone.classList.add('dragover');
        });
        
        uploadZone.addEventListener('dragleave', () => {
            uploadZone.classList.remove('dragover');
        });
        
        uploadZone.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadZone.classList.remove('dragover');
            if (e.dataTransfer.files.length > 0) {
                handleFiles(e.dataTransfer.files);
            }
        });
        
        // Handle Files
        function handleFiles(files) {
            const imageFiles = Array.from(files).filter(file => {
                const isImage = file.type.startsWith('image/');
                const isHeic = isHeicFile(file);
                return isImage || isHeic;
            });
            
            imageFiles.forEach(file => {
                const id = generateId();
                const exists = selectedFiles.some(f => 
                    f.file.name === file.name && f.file.size === file.size
                );
                
                if (!exists) {
                    // Dosyayƒ± 'waiting' (bekliyor) durumuyla ekle
                    selectedFiles.push({ id, file, status: 'waiting' }); 
                    log(`Eklendi: ${file.name} (${formatBytes(file.size)})`, 'info');
                }
            });
            
            renderFileList();
        }
        
        // Settings Toggle
        settingsToggle.addEventListener('click', () => {
            settingsPanel.classList.toggle('hidden');
            toggleArrow.style.transform = settingsPanel.classList.contains('hidden') ? '' : 'rotate(180deg)';
        });
        
        // Sliders
        maxWidthSlider.addEventListener('input', () => {
            maxWidthValue.textContent = maxWidthSlider.value + 'px';
        });
        
        qualitySlider.addEventListener('input', () => {
            qualityValue.textContent = qualitySlider.value + '%';
        });
        
        // Clear All
        clearAllBtn.addEventListener('click', () => {
            // NOTE: Custom modal UI kullanƒ±lƒ±yor
            if (!isUploading && confirm('T√ºm dosyalarƒ± temizlemek istediƒüinize emin misiniz?')) {
                resetUploader();
                log('Liste temizlendi', 'info');
            }
        });
        
        // Clear Success Only
        clearSuccessBtn.addEventListener('click', () => {
            if (!isUploading) {
                // Sadece ba≈üarƒ±lƒ± dosyalarƒ± kaldƒ±r
                selectedFiles = selectedFiles.filter(f => f.status !== 'success');
                renderFileList();
                clearSuccessBtn.classList.add('hidden');
                
                if (selectedFiles.length > 0) {
                    const remainingErrors = selectedFiles.filter(f => f.status === 'error').length;
                    const remainingWaiting = selectedFiles.filter(f => f.status === 'waiting').length;
                    
                    if (remainingErrors > 0 || remainingWaiting > 0) {
                         uploadBtn.disabled = false;
                         uploadBtnText.textContent = `‚¨ÜÔ∏è ${remainingErrors + remainingWaiting} Dosyayƒ± Tekrar Dene`;
                    } else {
                         uploadBtn.disabled = true;
                         uploadBtnText.textContent = 'Dosya Se√ßin';
                    }
                } else {
                    resetUploader();
                }
                log('Ba≈üarƒ±lƒ± dosyalar listeden kaldƒ±rƒ±ldƒ±', 'info');
            }
        });
        
        // Reset Function
        function resetUploader() {
            selectedFiles = [];
            renderFileList();
            progressContainer.classList.add('hidden');
            clearSuccessBtn.classList.add('hidden');
            uploadBtnText.textContent = 'Dosya Se√ßin';
            uploadBtn.disabled = true;
            progressBar.style.width = '0%';
        }
        
        // Clear Log
        clearLogBtn.addEventListener('click', () => {
            logArea.innerHTML = '';
        });
        
        // Upload Button
        uploadBtn.addEventListener('click', uploadFiles);
        
        // ============================================
        // Init
        // ============================================
        window.addEventListener('load', () => {
            setTimeout(() => {
                if (typeof heic2any !== 'undefined') {
                    log('‚úÖ HEIC desteƒüi aktif', 'success');
                } else {
                    log('‚ö†Ô∏è HEIC k√ºt√ºphanesi y√ºklenemedi! (Cross-Origin Sorunu)', 'error');
                    log('üí° √á√∂z√ºm: HTML dosyasƒ±nƒ± bir web sunucusu √ºzerinden a√ßƒ±n veya HEIC dosyalarƒ±nƒ± √∂nce JPG\'ye √ßevirin.', 'warning');
                }
                log('Uygulama hazƒ±r. Dosya se√ßin veya s√ºr√ºkleyin.', 'info');
            }, 500);
        });
    </script>
</body>
</html>
